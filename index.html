<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マップエディタ（画像分離版）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    h2 {
      margin-top: 30px;
    }

    #tileSelector, #playerSelector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      margin: 10px 0;
    }

    #tileSelector img, #playerSelector img {
      width: 40px;
      height: 40px;
      cursor: pointer;
      border: 2px solid transparent;
    }

    img.selected {
      border-color: red;
    }

    #map {
      display: grid;
      gap: 1px;
      margin-top: 10px;
    }

    .cell {
      width: 40px;
      height: 40px;
      background-color: #eee;
      border: 1px solid #ccc;
      position: relative;
    }

    .cell img {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .blocked {
      background-color: #333 !important;
    }

    .player {
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1>マップエディタ（プレイヤー・タイル分離）</h1>

  <div>
    <label>列（横）: <input type="number" id="cols" value="10" min="1"></label>
    <label>行（縦）: <input type="number" id="rows" value="10" min="1"></label>
    <button id="generateMap">マップ生成</button>
  </div>

  <h2>🧱 マップタイルアップロード</h2>
  <input type="file" id="tileUploader" accept="image/*" multiple>
  <div id="tileSelector"></div>

  <h2>🧍 プレイヤー画像アップロード</h2>
  <input type="file" id="playerUploader" accept="image/*">
  <div id="playerSelector"></div>

  <p><strong>使い方：</strong><br>
    ・マス画像をクリックして選択し、マップ上にクリックで配置。<br>
    ・プレイヤー画像を選んだ状態でマップをクリック：プレイヤー設置。<br>
    ・右クリック：移動不可マス（ブロック）切り替え。
  </p>

  <div id="map"></div>

  <script>
    const map = document.getElementById('map');
    const tileUploader = document.getElementById('tileUploader');
    const tileSelector = document.getElementById('tileSelector');
    const playerUploader = document.getElementById('playerUploader');
    const playerSelector = document.getElementById('playerSelector');
    const generateMapBtn = document.getElementById('generateMap');

    let selectedTile = null;
    let selectedPlayerImg = null;
    let playerPosition = null;
    let cells = [];

    function clearSelection(container) {
      container.querySelectorAll('img').forEach(img => img.classList.remove('selected'));
    }

    function removeExistingPlayer() {
      cells.forEach(cell => {
        const player = cell.querySelector('.player');
        if (player) cell.removeChild(player);
      });
    }

    function createMap(cols, rows) {
      map.innerHTML = '';
      map.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
      map.style.gridTemplateRows = `repeat(${rows}, 40px)`;

      cells = [];
      for (let i = 0; i < cols * rows; i++) {
        const cell = document.createElement('div');
        cell.classList.add('cell');
        cell.dataset.index = i;

        cell.addEventListener('click', (e) => {
          e.preventDefault();
          if (selectedPlayerImg) {
            removeExistingPlayer();
            const img = document.createElement('img');
            img.src = selectedPlayerImg.src;
            img.classList.add('player');
            cell.appendChild(img);
            playerPosition = cell;
          } else if (selectedTile) {
            cell.style.backgroundImage = `url(${selectedTile.src})`;
            cell.style.backgroundSize = 'cover';
          }
        });

        cell.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          cell.classList.toggle('blocked');
        });

        map.appendChild(cell);
        cells.push(cell);
      }
    }

    generateMapBtn.addEventListener('click', () => {
      const cols = parseInt(document.getElementById('cols').value);
      const rows = parseInt(document.getElementById('rows').value);
      if (cols > 0 && rows > 0) {
        createMap(cols, rows);
      }
    });

    // 初期マップ生成
    createMap(10, 10);

    tileUploader.addEventListener('change', (e) => {
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          img.addEventListener('click', () => {
            selectedTile = img;
            selectedPlayerImg = null;
            clearSelection(tileSelector);
            clearSelection(playerSelector);
            img.classList.add('selected');
          });
          tileSelector.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    playerUploader.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const img = document.createElement('img');
        img.src = reader.result;
        img.addEventListener('click', () => {
          selectedPlayerImg = img;
          selectedTile = null;
          clearSelection(tileSelector);
          clearSelection(playerSelector);
          img.classList.add('selected');
        });
        playerSelector.innerHTML = '';
        playerSelector.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
